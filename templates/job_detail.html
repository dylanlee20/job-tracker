{% extends "layout.html" %}

{% block title %}{{ job.title }} - 职位详情{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <!-- 返回按钮 -->
        <div class="mb-3">
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>

        <!-- 职位详情卡片 -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    {{ job.title }}
                    {% if job.is_new %}
                    <span class="badge bg-success">新</span>
                    {% endif %}
                    {% if job.is_updated %}
                    <span class="badge bg-warning">更新</span>
                    {% endif %}
                    {% if job.is_important %}
                    <span class="badge bg-danger"><i class="bi bi-star-fill"></i> 重点</span>
                    {% endif %}
                </h3>
            </div>
            <div class="card-body">
                <!-- 基本信息 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5><i class="bi bi-building"></i> 公司</h5>
                        <p class="text-muted">{{ job.company }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="bi bi-geo-alt"></i> 地点</h5>
                        <p class="text-muted">{{ job.location }}</p>
                    </div>
                </div>

                <!-- 日期信息 -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <h6>首次发现</h6>
                        <p class="text-muted">{{ job.first_seen[:10] }}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>最后看到</h6>
                        <p class="text-muted">{{ job.last_seen[:10] }}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>最后更新</h6>
                        <p class="text-muted">{{ job.last_updated[:10] }}</p>
                    </div>
                </div>

                <!-- 职位描述 -->
                <div class="mb-4">
                    <h5><i class="bi bi-file-text"></i> 职位描述</h5>
                    <div class="border rounded p-3 bg-light">
                        <p class="mb-0" style="white-space: pre-wrap;">{{ job.description or '暂无描述' }}</p>
                    </div>
                </div>

                <!-- 用户备注 -->
                <div class="mb-4">
                    <h5><i class="bi bi-pencil"></i> 我的备注</h5>
                    <textarea class="form-control" id="user-notes" rows="4"
                              placeholder="在这里添加你的备注...">{{ job.user_notes or '' }}</textarea>
                    <button class="btn btn-primary mt-2" onclick="saveNotes()">
                        <i class="bi bi-save"></i> 保存备注
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button class="btn btn-warning" id="important-btn" onclick="toggleImportant()">
                        <i class="bi bi-star{% if job.is_important %}-fill{% endif %}"></i>
                        {% if job.is_important %}取消重点{% else %}标记重点{% endif %}
                    </button>
                    <a href="{{ job.job_url }}" target="_blank" class="btn btn-primary">
                        <i class="bi bi-box-arrow-up-right"></i> 在新标签页打开
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const jobId = {{ job.id }};
let isImportant = {{ 'true' if job.is_important else 'false' }};

// 保存备注
function saveNotes() {
    const notes = $('#user-notes').val();

    $.ajax({
        url: `/api/jobs/${jobId}/notes`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ note: notes }),
        success: function(response) {
            if (response.success) {
                showNotification('备注已保存', 'success');
            } else {
                showNotification('保存失败: ' + response.error, 'error');
            }
        },
        error: function() {
            showNotification('保存失败，请稍后重试', 'error');
        }
    });
}

// 切换重点状态
function toggleImportant() {
    isImportant = !isImportant;

    $.ajax({
        url: `/api/jobs/${jobId}/important`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ is_important: isImportant }),
        success: function(response) {
            if (response.success) {
                showNotification(isImportant ? '已标记为重点' : '已取消重点标记', 'success');

                // 更新按钮文本和图标
                if (isImportant) {
                    $('#important-btn').html('<i class="bi bi-star-fill"></i> 取消重点');
                } else {
                    $('#important-btn').html('<i class="bi bi-star"></i> 标记重点');
                }
            } else {
                showNotification('操作失败: ' + response.error, 'error');
                isImportant = !isImportant; // 恢复状态
            }
        },
        error: function() {
            showNotification('操作失败，请稍后重试', 'error');
            isImportant = !isImportant; // 恢复状态
        }
    });
}
</script>
{% endblock %}
